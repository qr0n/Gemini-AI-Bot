{% extends "base.html" %}

{% block title %}Voice Settings - Nugget Tech{% endblock %}
{% block page_title %}Voice Settings{% endblock %}

{% block content %}
<div class="settings-grid">
    <div class="settings-card">
        <h2 class="settings-title">Text-to-Speech</h2>
        <p class="settings-description">Configure how the bot speaks</p>
        
        <form class="settings-form">
            <div class="form-group">
                <label for="voice_id" class="form-label">Voice</label>
                <select id="voice_id" name="voice_id" class="form-select">
                    <option value="en-US-Neural2-A">US English - Female</option>
                    <option value="en-US-Neural2-C">US English - Male</option>
                    <option value="en-GB-Neural2-A">British English - Female</option>
                    <option value="en-GB-Neural2-B">British English - Male</option>
                </select>
                <span class="form-hint">Select the voice for text-to-speech</span>
            </div>

            <div class="form-group">
                <label for="speaking_rate" class="form-label">Speaking Rate</label>
                <div class="range-with-value">
                    <input type="range" id="speaking_rate" name="speaking_rate" class="form-range" min="0.5" max="2" step="0.1" value="1">
                    <span class="range-value">1</span>
                </div>
                <span class="form-hint">Speed of speech (1 = normal)</span>
            </div>

            <div class="form-group">
                <label for="pitch" class="form-label">Pitch</label>
                <div class="range-with-value">
                    <input type="range" id="pitch" name="pitch" class="form-range" min="-10" max="10" step="1" value="0">
                    <span class="range-value">0</span>
                </div>
                <span class="form-hint">Voice pitch adjustment</span>
            </div>
        </form>
    </div>

    <div class="settings-card">
        <h2 class="settings-title">Speech Recognition</h2>
        <p class="settings-description">Configure voice input settings</p>

        <form class="settings-form">
            <div class="form-group">
                <label class="switch-container">
                    <span class="switch-label">Enable Voice Input</span>
                    <div class="switch-wrapper">
                        <input type="checkbox" id="enable_voice_input" name="enable_voice_input" class="switch-input">
                        <span class="switch"></span>
                    </div>
                </label>
                <span class="form-hint">Allow voice commands and dictation</span>
            </div>

            <div class="form-group">
                <label for="language" class="form-label">Recognition Language</label>
                <select id="language" name="language" class="form-select">
                    <option value="en-US">US English</option>
                    <option value="en-GB">British English</option>
                    <option value="en-AU">Australian English</option>
                    <option value="en-CA">Canadian English</option>
                </select>
                <span class="form-hint">Language for speech recognition</span>
            </div>

            <div class="form-group">
                <label for="sensitivity" class="form-label">Microphone Sensitivity</label>
                <div class="range-with-value">
                    <input type="range" id="sensitivity" name="sensitivity" class="form-range" min="0" max="100" step="5" value="75">
                    <span class="range-value">75</span>
                </div>
                <span class="form-hint">Adjust microphone input sensitivity</span>
            </div>
        </form>
    </div>

    <div class="settings-card">
        <h2 class="settings-title">Voice Triggers</h2>
        <p class="settings-description">Configure voice activation settings</p>

        <form class="settings-form">
            <div class="form-group">
                <label for="wake_word" class="form-label">Wake Word</label>
                <input type="text" id="wake_word" name="wake_word" class="form-input" value="Hey Nugget">
                <span class="form-hint">Word or phrase to activate voice input</span>
            </div>

            <div class="form-group">
                <label for="idle_timeout" class="form-label">Idle Timeout</label>
                <div class="input-with-suffix">
                    <input type="number" id="idle_timeout" name="idle_timeout" class="form-input" value="30" min="5" max="300">
                    <span class="input-suffix">seconds</span>
                </div>
                <span class="form-hint">Time to wait for voice input before timing out</span>
            </div>

            <div class="form-group">
                <label class="switch-container">
                    <span class="switch-label">Continuous Listening</span>
                    <div class="switch-wrapper">
                        <input type="checkbox" id="continuous_listening" name="continuous_listening" class="switch-input">
                        <span class="switch"></span>
                    </div>
                </label>
                <span class="form-hint">Always listen for the wake word</span>
            </div>
        </form>
    </div>
</div>

<div class="settings-actions">
    <button type="button" class="button button-secondary">Reset to Defaults</button>
    <button type="button" class="button button-primary">Save Changes</button>
</div>

{% endblock %}

{% block scripts %}
<script>
document.querySelectorAll('.form-range').forEach(slider => {
    const valueDisplay = slider.parentElement.querySelector('.range-value');
    slider.addEventListener('input', () => {
        valueDisplay.textContent = slider.value;
    });
});

// Save changes
document.querySelector('.button-primary').addEventListener('click', async () => {
    const formData = {};
    document.querySelectorAll('.settings-form input, .settings-form select').forEach(input => {
        formData[input.name] = input.type === 'checkbox' ? input.checked :
                              input.type === 'number' ? Number(input.value) :
                              input.value;
    });
    
    try {
        const response = await fetch('/api/{{ nugget_alias }}/voice', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            showToast('Settings saved successfully');
        } else {
            throw new Error('Failed to save settings');
        }
    } catch (error) {
        console.error('Error saving settings:', error);
        showToast('Error saving settings', 'error');
    }
});

// Reset to defaults
document.querySelector('.button-secondary').addEventListener('click', async () => {
    if (confirm('Are you sure you want to reset all voice settings to their defaults?')) {
        try {
            const response = await fetch('/api/{{ nugget_alias }}/voice/reset', {
                method: 'POST'
            });
            
            if (response.ok) {
                const defaults = await response.json();
                Object.entries(defaults).forEach(([key, value]) => {
                    const input = document.querySelector(`[name="${key}"]`);
                    if (input) {
                        if (input.type === 'checkbox') {
                            input.checked = value;
                        } else {
                            input.value = value;
                            if (input.type === 'range') {
                                input.dispatchEvent(new Event('input'));
                            }
                        }
                    }
                });
                showToast('Settings reset to defaults');
            } else {
                throw new Error('Failed to reset settings');
            }
        } catch (error) {
            console.error('Error resetting settings:', error);
            showToast('Error resetting settings', 'error');
        }
    }
});

// Test voice
document.getElementById('voice_id').addEventListener('change', async () => {
    const voiceId = document.getElementById('voice_id').value;
    const rate = document.getElementById('speaking_rate').value;
    const pitch = document.getElementById('pitch').value;
    
    try {
        const response = await fetch('/api/voice/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ voiceId, rate, pitch })
        });
        
        if (response.ok) {
            const audio = await response.blob();
            if (testVoice) {
                testVoice.pause();
            }
            testVoice = new Audio(URL.createObjectURL(audio));
            testVoice.play();
        }
    } catch (error) {
        showToast('Error testing voice', 'error');
    }
});
</script>
{% endblock %}
