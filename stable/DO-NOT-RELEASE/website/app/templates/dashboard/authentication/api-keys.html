{% extends "base.html" %}

{% block title %}API Keys - Nugget Tech{% endblock %}
{% block page_title %}ðŸ”‘ API Keys{% endblock %}
{% block page_title %}ðŸ”‘ API Keys{% endblock %}

{% block content %}
<div class="page-content">
    <div class="page-header">
        <p class="page-description">Configure and manage API keys for various AI services used by your bot.</p>
    </div>    <form id="api-keys-form" class="settings-form" action="/dashboard/{{nugget_alias}}/api-keys">
        <div class="settings-group">
            <div class="settings-card">
                <h2 class="card-title">ðŸ¤– AI Service Keys</h2>
                
                <div class="form-group">
                    <label for="gemini_api_key">Google Gemini API Key</label>
                    <div class="input-with-button">
                        <input type="password" id="gemini_api_key" name="gemini_api_key" class="input" value="{{ request.args.get('gemini_api_key', '') }}">
                        <button type="button" class="button button-icon toggle-visibility" aria-label="Toggle visibility">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="input-description">Your Gemini key for Gemini models</div>
                </div>

                <div class="form-group">
                    <label for="elevenlabs_api_key">ElevenLabs API Key</label>
                    <div class="input-with-button">
                        <input type="password" id="elevenlabs_api_key" name="elevenlabs_api_key" class="input" value="{{ request.args.get('elevenlabs_api_key', '') }}">
                        <button type="button" class="button button-icon toggle-visibility" aria-label="Toggle visibility">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="input-description">Your ElevenLabs API key for voice models</div>
                </div>

                <div class="form-group">
                    <label for="discord_token">Discord Bot Token</label>
                    <div class="input-with-button">
                        <input type="password" id="discord_token" name="discord_token" class="input" value="{{ request.args.get('discord_token', '') }}">
                        <button type="button" class="button button-icon toggle-visibility" aria-label="Toggle visibility">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="input-description">Your Discord bot token</div>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="button button-primary">
                <span class="button-icon">ðŸ’¾</span>
                Save Changes
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Toggle password visibility
document.querySelectorAll('.toggle-visibility').forEach(button => {
    button.addEventListener('click', () => {
        const input = button.parentElement.querySelector('input');
        const icon = button.querySelector('i');
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.replace('fa-eye-slash', 'fa-eye');
        }
    });
});

document.getElementById('api-keys-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Get form data and convert to URL parameters
    const formData = new FormData(e.target);
    const params = new URLSearchParams();
    for (const [key, value] of formData.entries()) {
        if (value) params.append(key, value);
    }
    
    // Construct URL with parameters
    const baseUrl = '/dashboard/auth/api-keys/save';
    const url = `${baseUrl}?${params.toString()}`;
    
    // Update the browser's URL to include the parameters
    window.history.pushState({}, '', url);
    
    // Submit the form
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(Object.fromEntries(formData))
        });

        if (response.ok) {
            alert('API keys saved successfully!');
        } else {
            throw new Error('Failed to save API keys');
        }
    } catch (error) {
        console.error('Error saving API keys:', error);
        alert('Error saving API keys. Please try again.');
    }
});

// Load values from URL parameters on page load
document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    for (const [key, value] of params) {
        const input = document.querySelector(`input[name="${key}"]`);
        if (input) input.value = value;
    }
});
</script>
{% endblock %}
